<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <title>Meditative MIDI - Web Generator</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial; margin:18px; background:#f6fbfb; color:#111; }
    .container { max-width:980px; margin:0 auto; }
    h1 { margin-bottom:6px; }
    .panel { background:#fff; padding:12px; border-radius:8px; box-shadow:0 4px 18px rgba(20,30,40,0.06); }
    label { display:block; margin-top:8px; font-weight:600; }
    select,input[type="number"],input[type="text"] { padding:6px; margin-top:6px; width:160px; }
    .controls { display:flex; gap:12px; flex-wrap:wrap; }
    button { padding:8px 12px; border-radius:6px; border:1px solid #cfe7e7; background:#eaf6f6; cursor:pointer; }
    button.strong { background:#2d9ab3; color:white; border-color:#2d9ab3; }
    .cols { display:grid; grid-template-columns:1fr 1fr; gap:14px; }
    .small { font-size:13px; color:#444; }
    pre { background:#fafafa; padding:8px; border-radius:6px; min-height:36px; }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.39/Tone.min.js"></script>
</head>
<body>
  <div class="container">
    <h1>Meditative Melody + Backing — Web</h1>
    <div class="panel">
      <div class="cols">
        <div>
          <label>Key</label>
          <select id="key"><option>C</option><option>G</option><option>D</option><option>A</option><option>E</option><option>B</option><option>F#</option><option>F</option><option>Bb</option><option>Eb</option><option>Ab</option><option>Db</option><option>Gb</option></select>
          <label>Scale</label>
          <select id="scale"><option value="pentatonic">Pentatonic</option><option value="dorian">Dorian</option><option value="minor">Minor</option><option value="lydian">Lydian</option></select>
          <label>BPM (30–60)</label>
          <input type="number" id="bpm" value="44" min="30" max="80" />
          <label>Bars</label>
          <input type="number" id="bars" value="8" min="1" max="64" />
          <label>Seed (optioneel)</label>
          <input type="text" id="seed" placeholder="Laat leeg voor random" />
          <div style="margin-top:10px">
            <button id="generate" class="strong">Genereer</button>
            <button id="randomize">Randomize seed</button>
          </div>
        </div>

        <div>
          <label>Chord density</label>
          <select id="density"><option value="1">1 change/bar</option><option value="2">2 changes/bar</option><option value="4">4 changes/bar</option></select>
          <label>Melody instrument</label>
          <select id="melodyInst"><option value="sine">Soft Sine</option><option value="fm">FM Bell</option><option value="pluck">Pluck</option></select>
          <label>Pad instrument</label>
          <select id="padInst"><option value="pad">Warm Pad</option><option value="softSaw">Soft Saw</option><option value="strings">Strings</option></select>

          <div style="margin-top:10px" class="controls">
            <button id="playMelody">Play Melody</button>
            <button id="playChords">Play Chords</button>
            <button id="playBoth" class="strong">Play Both</button>
            <button id="stopAll">Stop</button>
          </div>

          <div style="margin-top:10px">
            <button id="downloadMidi">Download MIDI (Logic-ready)</button>
          </div>
        </div>
      </div>

      <div style="margin-top:12px">
        <div class="small">Seed used:</div>
        <pre id="seedDisplay">—</pre>
        <div class="small">Status:</div>
        <pre id="status">Ready.</pre>
      </div>
    </div>
  </div>

<script>
/*
Frontend:
- Sends parameters to /api/generate (POST JSON)
- Receives midi_base64 and structure (melody/chords)
- Uses Tone.js to play melody/chords separately or together
- Allows downloading the MIDI (converted from base64)
*/

let current = { melody: [], chords: [], seed: null, bpm:44, midi_b64:null, markers:[] };

function setStatus(s){ document.getElementById('status').innerText = s; }
function setSeedDisplay(s){ document.getElementById('seedDisplay').innerText = s; }

function rndSeed() { return Math.floor(Math.random()*1e9).toString(); }

document.getElementById('randomize').addEventListener('click', ()=> {
  document.getElementById('seed').value = rndSeed();
});

async function generate() {
  setStatus('Generating on server...');
  const body = {
    key: document.getElementById('key').value,
    scale: document.getElementById('scale').value,
    bars: parseInt(document.getElementById('bars').value),
    bpm: parseInt(document.getElementById('bpm').value),
    density: parseInt(document.getElementById('density').value),
    seed: document.getElementById('seed').value || null
  };
  try {
    const res = await fetch('/api/generate', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body)});
    if (!res.ok) throw new Error('Server error');
    const json = await res.json();
    current.midi_b64 = json.midi_b64;
    current.melody = json.melody;
    current.chords = json.chords;
    current.seed = json.seed;
    current.bpm = json.bpm;
    current.markers = json.markers || [];
    setSeedDisplay(String(current.seed));
    setStatus(`Generated. Melody notes: ${current.melody.length}, Chord events: ${current.chords.length}`);
  } catch(err) {
    console.error(err);
    setStatus('Error generating: '+err.message);
  }
}

// Tone.js synth factory
function createSynth(kind){
  if (kind === 'sine') return new Tone.Synth({oscillator:{type:'sine'}, envelope:{attack:0.02,decay:0.4,sustain:0.8,release:1.4}}).toDestination();
  if (kind === 'fm') return new Tone.FMSynth({harmonicity:2.5, modulationIndex:1.5, envelope:{attack:0.01,decay:0.3,sustain:0.6,release:2}}).toDestination();
  if (kind === 'pluck') return new Tone.PluckSynth({dampening:2000}).toDestination();
  if (kind === 'pad') return new Tone.PolySynth(Tone.Synth, {oscillator:{type:'sine'}, envelope:{attack:1.2,decay:0.6,sustain:0.8,release:4}}).toDestination();
  if (kind === 'softSaw') return new Tone.PolySynth(Tone.Synth, {oscillator:{type:'sawtooth'}, envelope:{attack:0.6,decay:0.8,sustain:0.7,release:3}}).toDestination();
  if (kind === 'strings') return new Tone.PolySynth(Tone.Synth, {oscillator:{type:'sine'}, envelope:{attack:0.6,decay:0.6,sustain:0.85,release:5}}).toDestination();
  return new Tone.Synth().toDestination();
}

let melodySynth = null;
let chordSynth = null;

function schedulePlayback() {
  // Clear transport schedule
  Tone.Transport.cancel();
  Tone.Transport.bpm.value = current.bpm || 44;
  // prepare synths
  melodySynth = melodySynth || createSynth(document.getElementById('melodyInst').value);
  chordSynth = chordSynth || createSynth(document.getElementById('padInst').value);
  // schedule melody
  for (let ev of current.melody) {
    const start = ev.start;
    const dur = ev.dur;
    const vel = ev.vel ? (ev.vel/127) : 0.8;
    Tone.Transport.schedule((time) => {
      melodySynth.triggerAttack(Tone.Frequency(ev.midi, "midi").toNote(), time, vel);
      Tone.Transport.scheduleOnce(() => melodySynth.triggerRelease(Tone.Frequency(ev.midi, "midi").toNote()), time + (dur * 60/current.bpm));
    }, start);
  }
  // schedule chords
  for (let ev of current.chords) {
    const start = ev.start;
    const dur = ev.dur;
    Tone.Transport.schedule((time) => {
      for (let n of ev.notes) chordSynth.triggerAttack(Tone.Frequency(n, "midi").toNote(), time, 0.7);
      Tone.Transport.scheduleOnce(() => { for (let n of ev.notes) chordSynth.triggerRelease(Tone.Frequency(n, "midi").toNote()); }, time + (dur * 60/current.bpm));
    }, start);
  }
}

document.getElementById('generate').addEventListener('click', async ()=>{
  await generate();
});

document.getElementById('playMelody').addEventListener('click', async ()=>{
  if (!current.melody.length) { setStatus('Generate eerst.'); return; }
  await Tone.start();
  schedulePlayback();
  // cancel chords schedule
  // we scheduled both; to play only melody we need to re-schedule only melody => quick hack: schedule only melody
  Tone.Transport.cancel();
  Tone.Transport.bpm.value = current.bpm || 44;
  melodySynth = melodySynth || createSynth(document.getElementById('melodyInst').value);
  for (let ev of current.melody) {
    const start = ev.start;
    const dur = ev.dur;
    const vel = ev.vel ? (ev.vel/127) : 0.8;
    Tone.Transport.schedule((time)=> {
      melodySynth.triggerAttack(Tone.Frequency(ev.midi, "midi").toNote(), time, vel);
      Tone.Transport.scheduleOnce(()=>melodySynth.triggerRelease(Tone.Frequency(ev.midi, "midi").toNote()), time + (dur*60/current.bpm));
    }, start);
  }
  Tone.Transport.start();
  setStatus('Playing melody...');
});

document.getElementById('playChords').addEventListener('click', async ()=>{
  if (!current.chords.length) { setStatus('Generate eerst.'); return; }
  await Tone.start();
  Tone.Transport.cancel();
  Tone.Transport.bpm.value = current.bpm || 44;
  chordSynth = chordSynth || createSynth(document.getElementById('padInst').value);
  for (let ev of current.chords) {
    const start = ev.start;
    const dur = ev.dur;
    Tone.Transport.schedule((time)=> {
      for (let n of ev.notes) chordSynth.triggerAttack(Tone.Frequency(n, "midi").toNote(), time, 0.7);
      Tone.Transport.scheduleOnce(()=>{ for (let n of ev.notes) chordSynth.triggerRelease(Tone.Frequency(n, "midi").toNote()); }, time + (dur*60/current.bpm));
    }, start);
  }
  Tone.Transport.start();
  setStatus('Playing chords...');
});

document.getElementById('playBoth').addEventListener('click', async ()=>{
  if (!current.melody.length || !current.chords.length) { setStatus('Generate eerst.'); return; }
  await Tone.start();
  Tone.Transport.cancel();
  schedulePlayback();
  Tone.Transport.start();
  setStatus('Playing both...');
});

document.getElementById('stopAll').addEventListener('click', ()=>{
  Tone.Transport.stop();
  Tone.Transport.cancel();
  setStatus('Stopped.');
});

document.getElementById('downloadMidi').addEventListener('click', ()=>{
  if (!current.midi_b64) { setStatus('Genereer eerst een file.'); return; }
  const bytes = atob(current.midi_b64);
  const buf = new Uint8Array(bytes.length);
  for (let i=0;i<bytes.length;i++) buf[i]=bytes.charCodeAt(i);
  const blob = new Blob([buf], {type:'audio/midi'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `meditation_${current.seed || 'random'}.mid`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
  setStatus('MIDI downloaded.');
});

// initial generate for demo
(async ()=>{
  await new Promise(r=>setTimeout(r,150));
  document.getElementById('seed').value = '';
  await generate();
})();
</script>
</body>
</html>
